# License Agreements
#
# pVACtools is licensed under [NPOSL-3.0](http://opensource.org/licenses/NPOSL-3.0).
# By using the IEDB software, you are consenting to be bound by and become a "Licensee"
# for the use of IEDB tools and are consenting to the terms and conditions of the
# Non-Profit Open Software License ("Non-Profit OSL") version 3.0
# Please read these two license agreements [here](http://tools.iedb.org/mhci/download/)
# before proceeding. If you do not agree to all of the terms of these two agreements,
# you must not install or use the product. Companies (for-profit entities) interested in
# downloading the command-line versions of the IEDB tools or running the entire
# resource locally, should contact us (license@iedb.org) for details on licensing options.
#
# Citing the IEDB
# All publications or presentations of data generated by use of the IEDB Resource Analysis
# tools should include citations to the relevant reference(s), found
# [here](http://tools.iedb.org/mhci/reference/).

Bootstrap: docker
From: continuumio/miniconda3:4.9.2


%post
 apt-get update && apt-get install -y \
    tcsh \
    gcc \
    build-essential \
    zlib1g-dev \
    gawk \
    git \
    git-core \
    pandoc \
    libbz2-dev \
    libcurl4-openssl-dev \
    liblzma-dev \
    libssl-dev \
    cmake \
    libncurses-dev \
    patch


    export LANG=C.UTF-8 LC_ALL=C.UTF-8
    export PATH=/opt/conda/bin:$PATH

    conda config --add channels defaults
    conda config --add channels bioconda
    conda config --add channels conda-forge

    mkdir -p /opt/iedb

    wget -O /opt/iedb/LICENSE https://raw.githubusercontent.com/griffithlab/docker-pvactools/master/LICENSE

    cd /opt/iedb
    wget https://downloads.iedb.org/tools/mhci/3.1.1/IEDB_MHC_I-3.1.1.tar.gz
    tar -xzvf IEDB_MHC_I-3.1.1.tar.gz
    cd /opt/iedb/mhc_i
    bash -l -c "./configure"
    cd /opt/iedb
    rm IEDB_MHC_I-3.1.1.tar.gz

    wget https://downloads.iedb.org/tools/mhcii/3.1.2/IEDB_MHC_II-3.1.2.tar.gz
    tar -xzvf IEDB_MHC_II-3.1.2.tar.gz
    cd /opt/iedb/mhc_ii
    bash -l -c "python ./configure.py"
    cd /opt/iedb
    rm IEDB_MHC_II-3.1.2.tar.gz

    mkdir /opt/mhcflurry_data
    export MHCFLURRY_DATA_DIR=/opt/mhcflurry_data
    mkdir /data
    pip install --upgrade pip
    pip install tensorflow==2.2.0
    pip install pvactools==2.0.0
    mhcflurry-downloads fetch

    cd /opt
    mkdir tmp_src
    cd tmp_src

    git clone https://github.com/atks/vt.git
    cd vt
    # work around current version 20210210 is not building (https://github.com/atks/vt/issues/113)
    git checkout 0.577
    make
    cp vt /usr/local/bin
    chmod 755 /usr/local/bin/vt
    cd /opt/tmp_src
    rm -rf vt

    pip install cyvcf2
    pip install vatools
    wget -O /usr/local/bin/bam_readcount_helper.py https://raw.githubusercontent.com/genome/docker-bam_readcount_helper-cwl/master/bam_readcount_helper.py
    chmod 755 /usr/local/bin/bam_readcount_helper.py

    cd /opt/tmp_src
    git clone https://github.com/genome/bam-readcount.git
    cd bam-readcount
    cmake .
    make
    cp bin/bam-readcount /usr/bin
    chmod 755 /usr/bin/bam-readcount
    cd /opt/tmp_src
    rm -rf bam-readcount

    conda install tabix
    conda install bcftools


%environment
    export LANG=C.UTF-8 LC_ALL=C.UTF-8
    export PATH=/opt/conda/bin:$PATH
    export MHCFLURRY_DATA_DIR=/opt/mhcflurry_data
